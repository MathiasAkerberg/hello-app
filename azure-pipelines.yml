# Starter pipeline

# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- master

pool:
  vmImage: 'ubuntu-latest'

steps:

- task: Docker@2
  inputs:
    containerRegistry: 'octolabRegistry'
    repository: 'hello-app'
    command: 'buildAndPush'
    Dockerfile: '**/Dockerfile'

- task: OctopusPack@4
  inputs:
    PackageId: 'HelloApp'
    PackageFormat: 'NuPkg'
    PackageVersion: '$(Version.Number)'
    SourcePath: '$(Build.SourcesDirectory)/k8s'
    OutputPath: '$(Build.ArtifactStagingDirectory)'

- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)'
    ArtifactName: 'OctopusPkg'
    publishLocation: 'Container'
  
- task: OctopusPush@2
  inputs:
    OctoConnectedServiceName: 'srcilabvm01'
    Package: '$(Build.ArtifactStagingDirectory)/HelloApp.$(Version.Number).nupkg'
